<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../asq-base/asq-base.html">

<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-list/iron-list.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../paper-input/paper-textarea.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-tabs/paper-tab.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">

<!--
`asq-js-function-body-presenter-q` is the presenter element for `asq-js-function-body-q` 

A major feature is that it will evaluate the code instantly and show the result.

##### Example
      <asq-js-function-body-presenter-q function-name="wrap(str, tagName)" 
          test-exp="wrap('hello World', 'div');">
        <asq-stem><h4>Implement a function that wraps a given 
            string with an HTML tag:</h4></asq-stem>
      </asq-js-function-body-presenter-q>


@element asq-js-function-body-presenter-q
@demo demo/index.html
@group ASQ Elements
@blurb Element presenter element for `asq-js-function-body-q`.
@homepage http://github.com/ASQ-USI-Elements/asq-js-function-body-q
-->
<dom-module id="asq-js-function-body-presenter-q">

  <template>

    <style>

    :host{
      --paper-toolbar-background: #CFD8DC;
      --paper-toolbar-color: #000;  
      --paper-tabs-selection-bar-color: #333;
    }

    paper-textarea{
      --paper-input-container-focus-color: #CFD8DC;
      --paper-input-container-input-color: #FCFCFC;
      --paper-input-container-input:{
        font-size: 0.85em;
        font-family: Menlo,Monaco,Consolas,"Courier New",monospace;
      };
    }

     #le-content{
      @apply(--layout-horizontal);
      @apply(--asq-js-function-body-q-content);
     }

     #editor{
      @apply(--layout-flex-3);
      @apply(--asq-js-function-body-q-editor);
     }

     #header{
      @apply(--asq-js-function-body-q-header);
     }

     #list-container{
      @apply(--layout-flex);
      @apply(--layout-vertical);
     }

     #list-container iron-pages{
      @apply(--layout-flex);
      @apply(--layout-vertical);
     }

     #submissionList {
       @apply(--layout-flex-1);
     }

     #submissionList paper-item{
       overflow:hidden;
       padding: 12px 5px 0;
       background-color: white;
       cursor: pointer;
       font-family: Menlo,Monaco,Consolas,"Courier New",monospace;
       @apply(--shadow-elevation-2dp);
     }

      code, kbd, pre, samp {
        font-family: Menlo,Monaco,Consolas,"Courier New",monospace;
        font-size: 1em;
      }

      samp{
        font-size: 1em;
      }

      pre{
        width: 100%;
        box-sizing:border-box;
        background-color: #565656;
        color: #FCFCFC;
        display: block;
        padding: 9.5px;
        margin: 0 0 10px;
        line-height: 1.42857143;
        word-break: break-all;
        word-wrap: break-word;
        border: 1px solid #ccc;
        border-radius: 4px;
        overflow: auto;
      }

      pre.result-pre{
        background-color: transparent;
        color: inherit;
        border: none;
        border-radius: 0px;
        padding:0;
        margin:0;
      }

      #function-container{
        width: 100%;
        box-sizing:border-box;
        background-color: #565656;
        color: #FCFCFC;
        display: block;
        padding: 9.5px;
        margin: 0 0 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      kbd{
        padding: 2px 4px;
        font-size: 90%;
        color: #fff;
        background-color: #333;
        border-radius: 3px;
        -webkit-box-shadow: inset 0 -1px 0 rgba(0,0,0,.25);
        box-shadow: inset 0 -1px 0 rgba(0,0,0,.25);
      }

      .asq-code-input{
        @apply(--asq-js-function-body-q-code-input);
        box-sizing:border-box;
        padding: 4px 8px;
        border: 1px dashed #ccc;
        border-radius: 4px;
        -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        margin: 5px 0;
      }

      pre.asq-evaluate{
        padding:0;
        margin:0;
        background: transparent;
        color: #333;
        border: none;
      }

      h5 {
        font-size: 14px;
        margin-top: 10px;
        margin-bottom: 10px;
        font-family: inherit;
        font-weight: 500;
        line-height: 1.1;
        color: inherit;
      }

      .asq-result-wrapper, .asq-console-wrapper{
        position:relative;
        min-height: 20px;
        padding: 19px;
        margin-bottom: 20px;
        background-color: #f5f5f5;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.05);
        box-shadow: inset 0 1px 1px rgba(0,0,0,.05);
      }

      .asq-result-wrapper.asq-correct{
        background-color:#dff0d8;
      }

      .asq-correct-ok{
        position:absolute;
        top:5px;
        right: 8px;
        opacity:0;
      }

      .asq-correct .asq-correct-ok{
        color:#5cb85c;
        opacity:1;
      }
    </style>

    <content select="asq-stem"></content>
    <div id="le-content">
      <div id="editor">
        <div id="function-container">
          <code><span id="header" class="asq-code-header">function <span>{{ functionName }}</span>{</span>
            <div style="padding-left: 10px;">
            <paper-textarea id="code" class="asq-code-input" on-keydown="onTextareaKeydown" no-label-float  label="enter your code here" value="{{value}}" disabled="{{disabled}}"></paper-textarea>
          </div>
          <span id="footer" class="asq-code-footer">}</span>
          </code>
        </div>
        
        <div>
          <h5>Test</h5>
          <kbd class="asq-command-line">
            <i>  &gt; </i>
            <span id="evaluate" class="asq-evaluate">{{ testExp }}</span>
          </kbd>
        </div>

        <div>
          <h5>Result:</h5>
          <div id="wrapper" class="asq-result-wrapper">
            <i class="asq-correct-ok glyphicon glyphicon-ok"></i>
            <pre class="result-pre"><samp id="result" class="asq-result">{{ result }}</samp></pre>
          </div>
          <h5>Console:</h5>
          <div id="wrapper" class="asq-console-wrapper">
            <i class="asq-correct-ok glyphicon glyphicon-ok"></i>
            <pre class="result-pre"><samp id="result" class="asq-result">{{consoleTxt}}</samp></pre>
          </div>
        </div>
      </div>

      <div id="list-container">
        <paper-tabs selected="{{_selectedTab}}" selected="0" selected-attribute="active" noink role="tablist">     
          <paper-tab role="tab"></paper-tab>
          <paper-tab role="tab">Submissions</paper-tab>            
        </paper-tabs>
        <iron-pages selected="{{_selectedTab}}">
          <div></div>
          <iron-list id="submissionList" items="[[_submissions]]" as="submission" selection-enabled selected-item="{{_selectedSubmissionItem}}">
            <template>
              <paper-item>#<span>[[index]]</span>&nbsp;&nbsp;<span>[[submission.submission]]</span>
              </paper-item>
            </template>
          </iron-list>
        </iron-pages> 
      </div>

    </div>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'asq-js-function-body-presenter-q',

        behaviors: [ASQ.asqQuestionElementBehavior],

        properties: {
          /**
           * The expression that will be evaluated.
           */
          testExp: {
            type: 'String',
            value: '',
            notify: true
          },

          /**
           * The name of the function.
           */
          functionName: {
            type: 'String',
            value: '',
            notify: true
          },

          /**
           * Set to true to disable the element.
           */
          disabled: {
            type: Boolean,
            value: false,
            notify: true
          },

          /**
           * Get or set the text.
           */
          value: {
            type: 'String',
            value: '',
            observer: '_valueChanged',
            notify: true
          },

          /**
           * Result from the last evaluation.
           */
          result: {
            type: 'String',
            value: '',
            notify: true,
          },

          _selectedSubmissionItem: {
            observer: '_selectedSubmissionItemChanged'
          },

          _selectedTab:{
            notify: true
          },

          /**
           * Event bus to communicate with ASQ
           */
          eventBus: {
            type: Object,
            observer: "_eventBusChanged",
            notify: true
          }
        },

        onTextareaKeydown: function(event, detail){
          var keyCode = event.keyCode || event.which;

            // mute tabs
            if (keyCode == 9) {
              event.preventDefault();
            }
        },

        _onQuestionType: function (evt) {
          if (!evt || !evt.questionType)
            return;
          if (evt.questionType == 'asq-js-function-body-q') {
            if (evt.type == 'progress') {
              this._onProgress(evt);
            } else if (evt.type == 'restorePresenter') {
              this._onRestorePresenter(evt);
            }
          }
        },

        _onRestorePresenter: function (evt) {
          evt.questions.forEach(function(q){
           if(q.uid != this.uid) return;
           this._submissions = q.answers;
          }.bind(this));
        },

        _onProgress: function (evt) {
          if (!evt.question || evt.question.uid !== this.uid)
            return;

          this._submissions = evt.question.answers;
        },

        _subscribeToEvents: function (eventBus) {
          eventBus.on('asq:question_type', this._onQuestionType.bind(this));
        },


        _getSubmittedCode: function () {
          var submission = this.$.header.textContent + '\n';
          submission += this.value + '\n';
          submission += this.$.footer.textContent;
          submission += ';\n' + this.$.evaluate.textContent;
          return submission;
        },

        // evalInput: function (expr) {
        //   var result;
        //   try {
        //     result = eval(expr);
        //   } catch (err) {
        //     result = err.toString();
        //   }
        //   return JSON.stringify(result, undefined, 2);
        // },

                _update: function () {
          var submission = this._getSubmittedCode();

          // if you want DOM and document properties for the code you need
          // to uncomment the next two lines and comment those after.
          // var result = this.evalInput(submission);
          // this.result = result;

          // start with a new worker
          this._killWorker(this.worker);
          this.worker = new Worker(this.resolveUrl("../evalWorker.js"));

          // kill worker after 10 seconds no matter what
          var id = setTimeout(function(){
           this._killWorker(this.worker);
          }.bind(this), 10000);

          this.worker.onmessage = function(e) {
            clearTimeout(id);
            this._killWorker(this.worker);
            this.result = '';
            this.consoleTxt = '';
            if(e.data.type =="result"){
              this.result = e.data.value;
            }
            if(e.data.type== "console"){
              this.consoleTxt = e.data.value;
            }
          }.bind(this);

          this.worker.onerror = function(e) {
            clearTimeout(id);
            this._killWorker(this.worker);
            this.result = '[' + e.lineno + ':' + e.colno + '] '  + e.message;
          }.bind(this);

          // start worker
          this.worker.postMessage(submission);  
        },

        _killWorker: function(worker){
          if(! (worker instanceof Worker) ) return;
          worker.terminate();
          worker = null;
        },

        _selectedSubmissionItemChanged: function(newItem, old){
          if(! newItem) return;
          this.value = newItem.submission;
        },

        ready: function () {
          // scan for code changes every 300ms
          this.interval = 300;
          this.timer;
        },

        _valueChanged: function(value, old){
          //cancel previous timer
          clearTimeout(this.timer);

          //if nothing happens for this.interval ms we will evaluate the code
          timer = setTimeout(this._update.bind(this), this.interval);
        },

        _eventBusChanged: function (eventBus, old) {
          if(!eventBus) return;
          eventBus.on('asq:question_type', this._onQuestionType.bind(this));
        }
      });
    }());
  </script>
</dom-module>